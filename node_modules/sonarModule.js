var exec = require('child_process').exec;
var fs = require('fs');
var utilModule = require('utilModule');

var languageToFileMap = {'java' : 'java.properties',
						  'php' : 'php.properties' ,
						   'js' : 'js.properties' };

var nameOfPropertiesFile = 'sonar-project.properties';

var basePropertiesPath = function(){
	return __dirname.replace('node_modules','base_properties');
}

exports.analyze = function(language, projectLocation, link){
	 var sonar_runner_command = 'sonnar-runner';
	 console.log("lang  : " + language);
     generatePropertiesFile(language, projectLocation,link);
     console.log('going to projectLocation : ' + projectLocation);
     exec('cd ' + projectLocation);
     exec(sonar_runner_command); 

}


function generatePropertiesFile(language, projectLocation, newId) {

	var delimeter  = '/';
	var srcPath = basePropertiesPath() + delimeter + languageToFileMap[language];
	console.log("sourcepath : " + srcPath);
	var destPath = projectLocation + delimeter + nameOfPropertiesFile;
	console.log("destPath : " + projectLocation);

// 	utilModule.readTextFile(srcPath);
	//fs.createReadStream(srcPath).pipe(fs.createWriteStream(projectLocation));
	//readTextFile(srcPath);
	//console.log('--> readTextFile ' + readTextFile);
	var propertiesToChange = {'UNIQUE_KEY' : escapeCharacters(newId) };


	utilModule.copyFileAndChangeProperties(srcPath, destPath, propertiesToChange,
	  function(err){

		console.log("fileSuccesfully copied + err : " + err);
	});
}

function escapeCharacters(newId){
	var charToBeEscape = '/';
	var charToEscape = '_';
	return newId.replace(charToBeEscape, charToEscape);
}

