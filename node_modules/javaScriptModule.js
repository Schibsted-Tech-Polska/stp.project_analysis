var fs = require('fs');
var underscore = require('underscore');

exports.findSrcLocation = function(projectLocation, propertiesToChange, callback){
	console.log('--> in find src location');
	var finder = require('findit').find(projectLocation);
	var directoriesWithJsFile = [];
	var filesToOmit =["jshint", "jquery"];//find all files that should be omit

	finder.on('file', function (file) {
		if( contains( file, '.js') && notAny(file, filesToOmit, contains)  ){
    		console.log(file);
    		var extracted = extractDirectory(file);
    		
    		if(shouldPushNewPath(directoriesWithJsFile,extracted)){
    			directoriesWithJsFile.push(extracted);
    		}
    	}
	});
	finder.on('end', function(){
		console.log('find js files in : ' + directoriesWithJsFile);
		propertiesToChange.SRC = directoriesWithJsFile;
		callback(propertiesToChange);
	});
		
}

function shouldPushNewPath(directoriesWithJsFile,extracted){
	return !underscore.contains(directoriesWithJsFile,extracted)
    			&& !isSubpath(directoriesWithJsFile, extracted);
}

function isSubpath(paths, path){
	var result = false;
	paths.map(function(currentPath){
		if(contains(path, currentPath)){
			result = true;
		}
	});
	return result;
}

function contains(path, expression){
	if(path.indexOf(expression) != -1) 
		return true;
	return false;

} 

function notAny(path, expressions, predicate){
	var result = true;
	expressions.map(function(currentExpression){
		if(predicate(path, currentExpression)){
			result = false;
		}
	});
	return result;
}

function extractDirectory(path){
	var delimeter = '/';
	var splittedPath = path.split(delimeter);
	var indexOfLastElement = splittedPath.length - 1;
	var nameToCutFromPath = splittedPath[indexOfLastElement];
	var result = path.substring(0, path.length - nameToCutFromPath.length);
	console.log("----> result of extracting :  " + result);
	return result;


}